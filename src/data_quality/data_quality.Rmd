---
title: "Quality Control"
output: html_document
---

```{r include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r message=FALSE, warning=FALSE}
library(tidyverse)
```

```{r}
abundance <- read_csv("results/data/prepared/processed_abundance.csv")
groups <- read_csv("results/data/prepared/groups.csv")
plates <- read_csv("data/cohort_GD1/plates.csv")
```

```{r}
tidy_data <- abundance %>% 
  pivot_longer(-sample, names_to = "glycan", values_to = "abundance") %>% 
  left_join(groups, by = "sample") %>% 
  left_join(plates %>% select(sample, plate), by = "sample")

qc_data <-  tidy_data %>% 
  filter(group == "QC")

sample_data <- tidy_data %>% 
  filter(!group == "QC")
```

```{r}
qc_cv <- qc_data %>% 
  group_by(glycan) %>% 
  summarise(cv = sd(abundance) / mean(abundance))
```

```{r}
qc_cor_mat <- qc_data %>% 
  select(sample, glycan, abundance) %>% 
  pivot_wider(names_from = sample, values_from = abundance) %>% 
  column_to_rownames("glycan") %>%
  log2() %>% 
  cor()
qc_cor <- qc_cor_mat %>% 
  as.data.frame() %>% 
  rownames_to_column("sample1") %>% 
  pivot_longer(-sample1, names_to = "sample2", values_to = "r") %>% 
  mutate(
    sample1_no = as.integer(str_sub(sample1, start = 2)),
    sample2_no = as.integer(str_sub(sample2, start = 2))
  ) %>% 
  filter(sample1_no > sample2_no)
```

```{r}
temp <- qc_cor %>% 
  left_join(plates %>% select(sample, plate), by = c("sample1" = "sample")) %>% 
  rename(plate1 = plate) %>%
  left_join(plates %>% select(sample, plate), by = c("sample2" = "sample")) %>%
  rename(plate2 = plate)
inter_plate_qc_cor <- temp %>% 
  filter(plate1 != plate2)
intra_plate_qc_cor <- temp %>% 
  filter(plate1 == plate2)
rm(temp)
```

```{r}
global_cv <- sample_data %>% 
  group_by(glycan) %>% 
  summarise(cv = sd(abundance) / mean(abundance))

per_group_cv <- sample_data %>% 
  group_by(glycan, group) %>% 
  summarise(cv = sd(abundance) / mean(abundance), .groups = "drop")
```

For QC samples, median CV: `r median(qc_cv$cv)`.
`r sum(qc_cv$cv < 0.2)` (`r sum(qc_cv$cv < 0.2) / nrow(qc_cv) * 100`%) glycans have CV < 0.2.
For pair-wise correlation, median r: `r median(qc_cor$r)`,
inter-plate median r: `r median(inter_plate_qc_cor$r)`,
intra-plate median r: `r median(intra_plate_qc_cor$r)`.

```{r}
qc_cor_plot <- qc_cor %>% 
  mutate(
    sample1_order = as.integer(str_sub(sample1, start = 2)),
    sample2_order = as.integer(str_sub(sample2, start = 2))
  ) %>%
  ggplot(aes(reorder(sample1, sample1_order), reorder(sample2, sample2_order), fill = r)) +
  geom_tile(color = "white", linewidth = 1) +
  geom_text(aes(label = sprintf("%.2f", r)), size = 3, color = "white", fontface = "bold") +
  guides(fill = guide_colorbar(position = "inside")) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    legend.position.inside = c(0.2, 0.6),
    axis.title = element_blank(),
    axis.text.x = element_text(angle = 45),
  ) +
  scale_fill_distiller(palette = "YlOrRd", limits = c(0, 1), direction = 1) +
  scale_y_discrete(position = "right", labels = paste0("QC", 1:21)) +
  scale_x_discrete(position = "bottom", labels = paste0("QC", 2:22))
tgutil::ggpreview(qc_cor_plot, width = 8, height = 8)
```

```{r}
cor_boxplot <- bind_rows(list(
  `inter-plate` = inter_plate_qc_cor %>% select(sample1, sample2, r),
  `intra-plate` = intra_plate_qc_cor %>% select(sample1, sample2, r)
), .id = "type") %>% 
  ggplot(aes(type, r)) +
  geom_boxplot(aes(fill = type)) +
  ggsignif::geom_signif(
    comparisons = list(c("inter-plate", "intra-plate")),
    textsize = 3, vjust = -0.5,
    map_signif_level = function(p) {
      paste0("wilcox p = ", sprintf("%.2f", p))
    }
  ) +
  annotate(
    "text", x = 1, y = median(inter_plate_qc_cor$r) - 0.005, 
    label = sprintf("%.3f", median(inter_plate_qc_cor$r))
  ) +
  annotate(
    "text", x = 2, y = median(intra_plate_qc_cor$r) - 0.005, 
    label = sprintf("%.3f", median(intra_plate_qc_cor$r))
  ) +
  guides(fill = "none") +
  labs(x = NULL, y = "Pearson's r") +
  scale_y_continuous(expand = expansion(mult = 0, 0.02)) +
  theme_bw() +
  theme(
    panel.grid = element_blank(),
  )
tgutil::ggpreview(cor_boxplot, width = 2.5, height = 3)
```

```{r}
qc_boxplot <- ggplot(qc_data, aes(reorder(sample, plate), log2(abundance), fill = factor(plate))) +
  geom_boxplot() +
  labs(x = "Sample", y = "log2(Abundance)", fill = "plate") +
  theme_bw() +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
  ) +
  scale_y_continuous(expand = c(0.8, 0.8))
tgutil::ggpreview(qc_boxplot, width = 6, height = 3)
```

